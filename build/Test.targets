<Project ToolsVersion="14.0" DefaultTargets="Test">
  <Import Project="test/TestPackageProjects.targets" />
  <Import Project="test/TestProjects.targets" />


  <PropertyGroup>
    <PathListSeparator>:</PathListSeparator>
    <PathListSeparator Condition=" '$(OSName)' == 'win' ">%3b</PathListSeparator>
    <ExecPath>$(OutputDirectory)$(PathListSeparator)$(PATH)</ExecPath>
    <ExecPath Condition=" '$(OSName)' == 'win' ">$(OutputDirectory)</ExecPath>
    <TestPackagesDir>$(TestOutputDir)/packages/</TestPackagesDir>
    <TestArtifactsDir>$(TestOutputDir)/artifacts/</TestArtifactsDir>
    <TestResultXmlDir>$(TestOutputDir)/results/</TestResultXmlDir>
    <ExternalRestoreSourcesTestsContainer>$(TestArtifactsDir)/ExternalRestoreSourcesForTestsContainer.txt</ExternalRestoreSourcesTestsContainer>
  </PropertyGroup>

  <Target Name="Test"
          Condition=" '$(CLIBUILD_SKIP_TESTS)' != 'true' And !$(Architecture.StartsWith('arm')) "
          DependsOnTargets="TestsForBuildItself;BuildTests;">


    <Message Text="ASHUT" Importance="High" />

    <Exec Command="$(DotnetInOutputDirectory) exec $(RoslynDirectory)/bincore/VBCSCompiler.dll -shutdown" />

    <Message Text="Finished test execution" Importance="High" />
  </Target>

  <Target Name="PrepareTests"
          DependsOnTargets="Init;
                            SetupTestProjectData">
  </Target>

  <Target Name="RestoreTests"
          DependsOnTargets="PrepareTests;
                            CreateTestAssetPackageNuPkgs;">
  </Target>

  <Target Name="BuildTests"
          DependsOnTargets="RestoreTests;">
  </Target>

  <Target Name="CreateTestAssetPackageNuPkgs"
          DependsOnTargets="SetupTestPackageProjectData;"
          Outputs="%(TestPackageProject.Identity)">

  </Target>

  <Target Name="TestsForBuildItself">
    <DotNetMSBuild Arguments="/v:diag $(RepoRoot)/test/MsBuildScript.Tests/runtests.target /p:PB_AssetRootUrl=$(PB_AssetRootUrl)"
                   ToolPath="$(PreviousStageDirectory)" />
  </Target>

  <Target Name="EnsureStageSeparation">
    <DotNetMSBuild Arguments="/v:diag $(RepoRoot)/build_projects/Microsoft.DotNet.Cli.Build.SelfTest/InvokeWithStage0.proj /p:OutputDirectory=&quot;$(OutputDirectory)&quot;"
                   ToolPath="$(PreviousStageDirectory)" />
  </Target>
</Project>
